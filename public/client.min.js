var VERSION="1.0";var QUICK_LOGIN=false;var LURK_MODE=true;var ROOM_LINK=false;var SOUND=true;var AFK=false;var NATIVE_WIDTH=128;var NATIVE_HEIGHT=100;var ASSET_SCALE=2;var WIDTH=NATIVE_WIDTH*ASSET_SCALE;var HEIGHT=NATIVE_HEIGHT*ASSET_SCALE;var canvasScale;var AVATAR_W=10;var AVATAR_H=18;var AVATARS=37;var ALL_AVATARS_SHEET="allAvatars.png";var WALK_F=4;var EMOTE_F=2;var socket;var ROOMS;var SETTINGS;var IMAGES,SOUNDS;var SPEED=50;var ASSETS_FOLDER="assets/";var FONT_FILE="assets/monogram_extended.ttf";var FONT_SIZE=16;var font;var TEXT_H=8;var TEXT_PADDING=3;var TEXT_LEADING=TEXT_H+4;var LOGO_FILE="LogoEvento.png";var MENU_BG_FILE="menu_white.png";var BUBBLE_TIME=8;var BUBBLE_MARGIN=3;var LOGO_STAY=-1;var PAGE_COLOR="#000000";var REF_COLORS=["#413830","#c0692a","#ff004d","#29adff"];var HAIR_COLORS=["#413830","#413830","#413830","#742f29","#742f29","#742f29","#ffa300","#a8e72e","#a28879","#be1250","#ffec27","#00b543","#ff6c24",];var SKIN_COLORS=["#e27c32","#8f3f17","#ffccaa"];var TOP_COLORS=["#a8e72e","#111d35","#c2c3c7","#f3ef7d","#ca466d","#111d35","#ffec27","#1e839d","#ff004d","#ff9d81","#ff6c24","#ffec27","#be1250","#b7250b",];var BOTTOM_COLORS=["#00b543","#a28879","#422136","#ca466d","#ffec27","#1e839d","#ff6c24","#be1250","#413830","#c2c3c7"];var HAIR_COLORS_RGB=[];var SKIN_COLORS_RGB=[];var TOP_COLORS_RGB=[];var BOTTOM_COLORS_RGB=[];var REF_COLORS_RGB=[];var generatedPalettes=[];var paletteIndex=0;var LABEL_NEUTRAL_COLOR="#FFFFFF";var UI_BG="#000000";var walkSheets=[];var emoteSheets=[];var allSheets;var bg;var areas;var room;var nextCommand;var areaLabel;var labelColor;var rolledSprite;var logo;var logoCounter;var walkIcon;var menuBg,arrowButton;var menuGroup;var avatarPreview;var longText="";var longTextLines;var longTextAlign;var longTextLink="";var LONG_TEXT_BOX_W=220;var LONG_TEXT_PADDING=4;var errorMessage="";var bubbles=[];var nickName="";var currentAvatar;var currentColors=[0,0,0,0];var players;var me;var canvas;var screen;var lastMessage=0;var appearEffect,disappearEffect;var blips;var appearSound,disappearSound;var firstLog=true;var START_TIME=-1;var dataLoaded=false;var gameStarted=false;var roomsLoaded=false;var soundsLoaded=false;var imagesLoaded=false;var settingsLoaded=false;var dataReady=false;function preload(){document.body.style.backgroundColor=PAGE_COLOR;showLoading(true);allSheets=loadImage(ASSETS_FOLDER+ALL_AVATARS_SHEET);REF_COLORS_RGB=[];for(var i=0;i<REF_COLORS.length;i++){var rc=REF_COLORS[i];var r=red(rc);var g=green(rc);var b=blue(rc);REF_COLORS_RGB[i]=[r,g,b]}for(var i=0;i<HAIR_COLORS.length;i++){HAIR_COLORS_RGB[i]=[];for(var j=0;j<HAIR_COLORS[i].length;j++){var rc=HAIR_COLORS[i];HAIR_COLORS_RGB[i]=[red(rc),green(rc),blue(rc)]}}for(var i=0;i<SKIN_COLORS.length;i++){SKIN_COLORS_RGB[i]=[];for(var j=0;j<SKIN_COLORS[i].length;j++){var rc=SKIN_COLORS[i];SKIN_COLORS_RGB[i]=[red(rc),green(rc),blue(rc)]}}for(var i=0;i<TOP_COLORS.length;i++){TOP_COLORS_RGB[i]=[];for(var j=0;j<TOP_COLORS[i].length;j++){var rc=TOP_COLORS[i];TOP_COLORS_RGB[i]=[red(rc),green(rc),blue(rc)]}}for(var i=0;i<BOTTOM_COLORS.length;i++){BOTTOM_COLORS_RGB[i]=[];for(var j=0;j<BOTTOM_COLORS[i].length;j++){var rc=BOTTOM_COLORS[i];BOTTOM_COLORS_RGB[i]=[red(rc),green(rc),blue(rc)]}}menuBg=loadImage(ASSETS_FOLDER+MENU_BG_FILE);arrowButton=loadImage(ASSETS_FOLDER+"arrowButton.png");var logoSheet=loadSpriteSheet(ASSETS_FOLDER+LOGO_FILE,60,90,2);logo=loadAnimation(logoSheet);logo.frameDelay=15;var walkIconSheet=loadSpriteSheet(ASSETS_FOLDER+"walkIcon.png",6,8,4);walkIcon=loadAnimation(walkIconSheet);walkIcon.frameDelay=8;var appearEffectSheet=loadSpriteSheet(ASSETS_FOLDER+"appearEffect.png",10,18,10);appearEffect=loadAnimation(appearEffectSheet);appearEffect.frameDelay=4;appearEffect.looping=false;var disappearEffectSheet=loadSpriteSheet(ASSETS_FOLDER+"disappearEffect.png",10,18,10);disappearEffect=loadAnimation(disappearEffectSheet);disappearEffect.looping=false;font=loadFont(FONT_FILE);soundFormats("mp3","ogg");blips=[];for(var i=0;i<=5;i++){var blip=loadSound(ASSETS_FOLDER+"blip"+i);blip.playMode("sustain");blip.setVolume(0.3);blips.push(blip)}appearSound=loadSound(ASSETS_FOLDER+"appear");appearSound.playMode("sustain");appearSound.setVolume(0.3);disappearSound=loadSound(ASSETS_FOLDER+"disappear");disappearSound.playMode("sustain");disappearSound.setVolume(0.3)}function setup(){canvas=createCanvas(WIDTH,HEIGHT);canvas.mousePressed(canvasPressed);canvas.mouseReleased(canvasReleased);canvas.mouseOut(outOfCanvas);canvas.parent("canvas-container");scaleCanvas();noSmooth();if(walkSheets.length==0&&allSheets!=null){var sliceX=0;for(var i=0;i<AVATARS;i++){var walkSheet=createImage(AVATAR_W*WALK_F,AVATAR_H);walkSheet.copy(allSheets,sliceX,0,AVATAR_W*WALK_F,AVATAR_H,0,0,AVATAR_W*WALK_F,AVATAR_H);walkSheets[i]=walkSheet;sliceX+=AVATAR_W*WALK_F;var emoteSheet=createImage(AVATAR_W*EMOTE_F,AVATAR_H);emoteSheet.copy(allSheets,sliceX,0,AVATAR_W*EMOTE_F,AVATAR_H,0,0,AVATAR_W*EMOTE_F,AVATAR_H);emoteSheets[i]=emoteSheet;sliceX+=AVATAR_W*EMOTE_F}}socket=io({autoConnect:false});socket.on("nameValidation",nameValidationCallBack);socket.on("serverWelcome",function(serverVersion,data,_START_TIME){if(socket.id){console.log("Welcome! Server version: "+serverVersion+" - client version "+VERSION+" started "+_START_TIME);START_TIME=_START_TIME;if(serverVersion!=VERSION){errorMessage="VERSION MISMATCH: PLEASE HARD REFRESH";document.body.innerHTML=errorMessage;socket.disconnect()}ROOMS=data.rooms;SETTINGS=data.settings;for(var roomId in ROOMS){if(ROOMS.hasOwnProperty(roomId)){var room=ROOMS[roomId];if(room.bg!=null)room.bgGraphics=loadImage(ASSETS_FOLDER+room.bg);else console.log("WARNING: room "+roomId+" has no background graphics");if(room.area!=null)room.areaGraphics=loadImage(ASSETS_FOLDER+room.area);else console.log("WARNING: room "+roomId+" has no area graphics");if(room.music!=null){room.musicLoop=loadSound(ASSETS_FOLDER+room.music);room.musicLoop.playMode("restart")}if(ROOMS[roomId].things!=null)for(var id in ROOMS[roomId].things){var spr=ROOMS[roomId].things[id];spr.spriteGraphics=loadImage(ASSETS_FOLDER+spr.file)}}}var imageData=data.images;IMAGES={};for(var i=0;i<imageData.length;i++){IMAGES[imageData[i][0]]=loadImage(ASSETS_FOLDER+imageData[i][1])}var soundData=data.sounds;SOUNDS={};for(var i=0;i<soundData.length;i++){SOUNDS[soundData[i][0]]=loadSound(ASSETS_FOLDER+soundData[i][1])}dataReady=true;print(">>> DATA RECEIVED "+(ROOMS!=null))}});socket.open()}function draw(){if(!dataLoaded){dataLoaded=soundsLoaded&&roomsLoaded&&imagesLoaded&&settingsLoaded}if(dataLoaded&&dataReady){for(var roomId in ROOMS){var room=ROOMS[roomId];if(room.bgGraphics!=null)if(room.bgGraphics.width==1)dataLoaded=false;if(room.areaGraphics!=null)if(room.areaGraphics.width==1)dataLoaded=false;if(room.musicLoop!=null)if(!room.musicLoop.isLoaded())dataLoaded=false}for(var imageId in IMAGES){if(IMAGES[imageId].width==1&&IMAGES[imageId].height==1){dataReady=false}}for(var soundId in SOUNDS){if(!SOUNDS[soundId].isLoaded()){dataReady=false}}print("Room data and assets loaded")}if(dataReady&&!gameStarted){setupGame()}if(gameStarted){update()}}function setupGame(){gameStarted=true;showLoading(false);if(ROOM_LINK){const urlParams=new URLSearchParams(window.location.search);const urlRoom=urlParams.get("room");if(urlRoom!=null){if(ROOMS[urlRoom]!=null)SETTINGS.defaultRoom=urlRoom}}if(QUICK_LOGIN){nickName="user"+floor(random(0,1000));currentColors=randomizeAvatarColors();currentAvatar=floor(random(0,walkSheets.length));newGame()}else if(!LURK_MODE){image(menuBg,0,0,WIDTH,HEIGHT);hideJoin();showUser();var field=document.getElementById("lobby-field");field.focus()}else{nickName="";currentColors=randomizeAvatarColors();generatedPalettes=[];generatedPalettes.push(currentColors);paletteIndex=0;currentAvatar=floor(random(0,walkSheets.length));newGame()}}function newGame(){screen="game";nextCommand=null;areaLabel="";rolledSprite=null;logoCounter=0;hideUser();hideAvatar();if(menuGroup!=null)menuGroup.removeSprites();if(nickName==""){showJoin()}else{showChat()}if(socket!=null){socket.disconnect();socket=null}socket=io({autoConnect:false,});background(UI_BG);players={};socket.on("connect",function(){try{players={};if(screen=="avatar"||screen=="user"){screen="error";errorMessage="SERVER RESTARTED: PLEASE REFRESH";socket.disconnect()}bubbles=[];if(me==null){var sx=-100;var sy=-100;if(ROOMS[SETTINGS.defaultRoom].spawn==null){console.log("WARNING: "+SETTINGS.defaultRoom+" has no spawn area")}else{spawnZone=ROOMS[SETTINGS.defaultRoom].spawn;var sx=round(random(spawnZone[0]*ASSET_SCALE,spawnZone[2]*ASSET_SCALE));var sy=round(random(spawnZone[1]*ASSET_SCALE,spawnZone[3]*ASSET_SCALE))}socket.emit("join",{nickName:nickName,colors:currentColors,avatar:currentAvatar,room:SETTINGS.defaultRoom,x:sx,y:sy,})}else{socket.emit("join",{nickName:nickName,colors:currentColors,avatar:currentAvatar,room:me.room,x:me.x,y:me.y,})}}catch(e){console.log("Error on connect");console.error(e)}});socket.on("playerJoined",function(p){try{p.destinationX=p.x;p.destinationY=p.y;if(socket.id==p.id){rolledSprite=null;if(ROOM_LINK&&ROOMS[p.room]!=null)window.history.replaceState(null,null,"?room="+p.room);players={};bubbles=[];deleteAllSprites();players[p.id]=me=new Player(p);me.sprite.onMousePressed=function(){socket.emit("emote",{room:me.room,em:true})};me.sprite.onMouseReleased=function(){socket.emit("emote",{room:me.room,em:false})};room=p.room;if(ROOMS[p.room].pageBg!=null)document.body.style.backgroundColor=ROOMS[p.room].pageBg;else document.body.style.backgroundColor=PAGE_COLOR;if(ROOMS[p.room].bgGraphics!=null){var bgg=ROOMS[p.room].bgGraphics;var f=1;if(ROOMS[p.room].frames!=null)f=ROOMS[p.room].frames;var ss=loadSpriteSheet(bgg,NATIVE_WIDTH,NATIVE_HEIGHT,f);bg=loadAnimation(ss);if(ROOMS[p.room].frameDelay!=null){bg.frameDelay=ROOMS[p.room].frameDelay}}if(ROOMS[p.room].avatarScale==null)ROOMS[p.room].avatarScale=2;areas=ROOMS[p.room].areaGraphics;if(areas==null)print("ERROR: no area assigned to  "+p.room);if(ROOMS[p.room].things!=null)for(var tId in ROOMS[p.room].things){var thing=ROOMS[p.room].things[tId];createThing(thing,tId)}if(ROOMS[p.room].musicLoop!=null&&SOUND){var vol=1;if(ROOMS[p.room].musicVolume!=null)vol=ROOMS[p.room].musicVolume;var now=Date.now();var timeDiff=(now-START_TIME)/1000;var l=ROOMS[p.room].musicLoop;var startTime=timeDiff%l.duration();l.loop(0,1,vol,startTime)}if(window.initMod!=null){window.initMod(p.id,p.room)}}else{players[p.id]=new Player(p);socket.emit("intro",p.id,{id:socket.id,nickName:me.nickName,colors:me.colors,avatar:me.avatar,room:me.room,x:me.x,y:me.y,destinationX:me.destinationX,destinationY:me.destinationY,})}if(p.new&&p.nickName!=""&&firstLog){var spark=createSprite(p.x,p.y-AVATAR_H+1);spark.addAnimation("spark",appearEffect);spark.scale=ASSET_SCALE;spark.life=60;if(SOUND)appearSound.play();if(p.id==me.id){longText=SETTINGS.INTRO_TEXT;longTextLines=1;longTextAlign="center"}firstLog=false}console.log("There are now "+Object.keys(players).length+" players in this room");if(window[p.room+"Enter"]!=null){window[p.room+"Enter"](p.id,p.room)}}catch(e){console.log("Error on playerJoined");console.error(e)}});socket.on("onIntro",function(p){try{players[p.id]=new Player(p);if(p.room!=null)if(window[p.room+"Intro"]!=null){window[p.room+"Intro"](p.id,p.room)}console.log("There are now "+Object.keys(players).length+" players in this room")}catch(e){console.log("Error on onIntro");console.error(e)}});socket.on("playerMoved",function(p){try{if(players.hasOwnProperty(p.id)){players[p.id].destinationX=p.destinationX;players[p.id].destinationY=p.destinationY}}catch(e){console.log("Error on playerMoved");console.error(e)}});socket.on("playerLeft",function(p){try{console.log("Player "+p.id+" left "+p.room);if(me&&p.id==me.id){print("STOP MUSIC");if(ROOMS[p.room].musicLoop!=null){ROOMS[p.room].musicLoop.stop()}}if(players[p.id]!=null){if(window[p.room+"Exit"]!=null){window[p.room+"Exit"](p.id)}if(p.disconnect&&players[p.id].nickName!=""){var spark=createSprite(players[p.id].x,players[p.id].y-AVATAR_H+1);spark.addAnimation("spark",disappearEffect);spark.scale=ASSET_SCALE;spark.life=60;if(SOUND)disappearSound.play()}if(players[p.id].sprite!=null){if(players[p.id].sprite==rolledSprite){rolledSprite=null}removeSprite(players[p.id].sprite)}}delete players[p.id];console.log("There are now "+Object.keys(players).length+" players in this room")}catch(e){console.log("Error on playerLeft");console.error(e)}});socket.on("playerTalked",function(p){try{console.log("new message from "+p.id+": "+p.message+" bubble color "+p.color);if(players.hasOwnProperty(p.id)){if(!players[p.id].ignore){var offY=ROOMS[me.room].bubblesY*ASSET_SCALE;var newBubble=new Bubble(p.id,p.message,p.color,p.x,p.y,offY);if(window[me.room+"Talk"]!=null){window[me.room+"Talk"](p.id,newBubble)}pushBubbles(newBubble);bubbles.push(newBubble);if(SOUND){blips[floor(random(0,blips.length))].play()}}}}catch(e){console.log("Error on playerTalked");console.error(e)}});socket.on("nonPlayerTalked",function(np){try{var offY=ROOMS[np.room].bubblesY*ASSET_SCALE;var newBubble=new Bubble(np.id,np.message,0,np.x,np.y,offY);newBubble.color=color(np.labelColor);pushBubbles(newBubble);bubbles.push(newBubble);if(SOUND){blips[floor(random(0,blips.length))].play()}}catch(e){console.log("Error on nonPlayerTalked");console.error(e)}});socket.on("errorMessage",function(msg){if(socket.id){screen="error";errorMessage=msg;hideChat();hideUser();hideAvatar();hideJoin()}});socket.on("godMessage",function(msg){if(socket.id){longText=msg;longTextLines=-1;longTextAlign="center";longTextLink=""}});socket.on("playerEmoted",function(id,em){try{if(players[id]!=null){if(players[id].sprite!=null){if(em){players[id].sprite.changeAnimation("emote");players[id].sprite.animation.changeFrame(1);players[id].sprite.animation.stop()}else{players[id].sprite.changeAnimation("emote");players[id].sprite.animation.changeFrame(0);players[id].sprite.animation.stop()}}}}catch(e){console.log("Error on playerTalked");console.error(e)}});socket.on("thingChanged",function(t){var dataThing=ROOMS[t.room].things[t.thingId];if(dataThing!=null&&t.room==me.room){removeThing(t.thingId,t.room);dataThing[t.property]=t.value;print("Change property "+t.property+" of "+t.thingId+" in room "+t.room+" to "+t.value);createThing(dataThing,t.thingId)}else{}});socket.on("nameValidation",nameValidationCallBack);socket.on("popup",function(msg){if(socket.id){alert(msg)}});socket.on("playerBlurred",function(id){if(players[id]!=null)players[id].sprite.transparent=true});socket.on("playerFocused",function(id){if(players[id]!=null)players[id].sprite.transparent=false});socket.on("disconnect",function(){});socket.on("refresh",function(){socket.disconnect();location.reload(true)});socket.open()}function update(){if(screen=="user"){image(menuBg,0,0,WIDTH,HEIGHT)}else if(screen=="bienvenida"){image(menuBg,0,0,WIDTH,HEIGHT)}else if(screen=="avatar"){image(menuBg,0,0,WIDTH,HEIGHT);textFont(font,FONT_SIZE);textAlign(CENTER,BASELINE);fill(0);text("Cuerpx",24*ASSET_SCALE,44*ASSET_SCALE);text("Color",105*ASSET_SCALE,44*ASSET_SCALE);text("Elegí tu avatar",64*ASSET_SCALE,18*ASSET_SCALE);menuGroup.draw()}else if(screen=="error"){textFont(font,FONT_SIZE);textAlign(CENTER,CENTER);fill(UI_BG);rect(0,0,WIDTH,HEIGHT);fill(LABEL_NEUTRAL_COLOR);text(errorMessage,floor(WIDTH/8),floor(HEIGHT/8),WIDTH-floor(WIDTH/4),HEIGHT-floor(HEIGHT/4)+1)}else if(screen=="game"){if(window[room+"Update"]!=null){window[room+"Update"]()}background(UI_BG);imageMode(CORNER);if(bg!=null){push();scale(ASSET_SCALE);translate(-NATIVE_WIDTH/2,-NATIVE_HEIGHT/2);animation(bg,floor(WIDTH/2),floor(HEIGHT/2));pop()}textFont(font,FONT_SIZE);for(var playerId in players){if(players.hasOwnProperty(playerId)){var p=players[playerId];var prevX,prevY;if(p.x!=null&&p.y!=null){prevX=p.x;prevY=p.y;if(p.x!=p.destinationX||p.y!=p.destinationY){var destination=createVector(p.destinationX,p.destinationY);var position=createVector(p.x,p.y);var distance=destination.dist(position);var delta=destination.sub(position);delta.normalize();var increment=delta.mult((SPEED*deltaTime)/1000);position.add(increment);var newDistance=position.dist(createVector(p.destinationX,p.destinationY));if(newDistance>distance){p.x=p.destinationX;p.y=p.destinationY;p.stopWalkingAnimation()}else{var obs=isObstacle(position.x-AVATAR_W/2,position.y,p.room,areas);var obs2=isObstacle(position.x+AVATAR_W/2,position.y,p.room,areas);var obs3=isObstacle(position.x,position.y,p.room,areas);if(!obs&&!obs2&&!obs3){p.x=position.x;p.y=position.y;p.playWalkingAnimation()}else{var obsX=isObstacle(position.x-AVATAR_W/2,p.y,p.room,areas);var obsX2=isObstacle(position.x+AVATAR_W/2,p.y,p.room,areas);var obsX3=isObstacle(position.x,p.y,p.room,areas);if(!obsX&&!obsX2&&!obsX3&&abs(delta.x)>0.1){p.x+=((SPEED*deltaTime)/1000)*(p.x>position.x)?-1:1;p.playWalkingAnimation()}else{var obsY=isObstacle(p.x-AVATAR_W/2,position.y,p.room,areas);var obsY2=isObstacle(p.x+AVATAR_W/2,position.y,p.room,areas);var obsY3=isObstacle(p.x,position.y,p.room,areas);if(!obsY&&!obsY2&&!obsY3&&abs(delta.y)>0.1){p.y+=((SPEED*deltaTime)/1000)*(p.y>position.y)?-1:1;p.playWalkingAnimation()}else{p.destinationX=p.x;p.destinationY=p.y;p.stopWalkingAnimation();if(p==me){nextCommand=null;socket.emit("move",{x:me.x,y:me.y,room:me.room,destinationX:me.x,destinationY:me.y,})}}}}if(prevX!=p.x){p.dir=prevX>p.x?-1:1;p.sprite.mirrorX(p.dir)}}}else{p.stopWalkingAnimation()}var illegal=isObstacle(p.x,p.y,p.room,areas);if(illegal){p.ignore=true;if(p.sprite!=null)p.sprite.ignore=true}else{p.ignore=false;if(p.sprite!=null)p.sprite.ignore=false}if(p==me){if(me.x==me.destinationX&&me.y==me.destinationY&&nextCommand!=null){executeCommand(nextCommand);nextCommand=null}}p.updatePosition()}}}for(var i=0;i<allSprites.length;i++){var dOff=0;if(allSprites[i].depthOffset!=null)dOff=allSprites[i].depthOffset;allSprites[i].depth=allSprites[i].position.y+dOff}drawSprites();if(nickName!=""&&rolledSprite==null&&areaLabel=="")animation(walkIcon,floor(mouseX+6),floor(mouseY-6));for(var i=0;i<bubbles.length;i++){var b=bubbles[i];var speaker=players[bubbles[i].pid];if(speaker!=null&&!b.orphan){if(round(speaker.x)==b.px&&round(speaker.y)==b.py){var s=ROOMS[speaker.room].avatarScale;strokeWeight(s);stroke(UI_BG);strokeCap(SQUARE);line(floor(speaker.x),floor(speaker.y-AVATAR_H*s-BUBBLE_MARGIN),floor(speaker.x),floor(b.y))}else{b.orphan=true}}}for(var i=0;i<bubbles.length;i++){bubbles[i].update()}for(var i=0;i<bubbles.length;i++){if(bubbles[i].counter<0){bubbles.splice(i,1);i--}}var label=areaLabel;var labelColor=LABEL_NEUTRAL_COLOR;if(nickName=="")label="";if(rolledSprite!=null){if(rolledSprite.label!=null&&rolledSprite.label!=""){label=rolledSprite.label+(rolledSprite.transparent?"[AFK]":"")}if(rolledSprite.labelColor!=null){labelColor=rolledSprite.labelColor}}if(me!=null)if(label==me.nickName)label="";if(label!=""&&longText==""){textFont(font,FONT_SIZE);textAlign(LEFT,BASELINE);var lw=textWidth(label);var lx=mouseX;if(mouseX+lw+TEXT_PADDING*2>width){lx=width-lw-TEXT_PADDING*2}fill(UI_BG);noStroke();rect(floor(lx),floor(mouseY-TEXT_H-TEXT_PADDING*2),lw+TEXT_PADDING*2+1,TEXT_H+TEXT_PADDING*2+1);fill(labelColor);text(label,floor(lx+TEXT_PADDING)+1,floor(mouseY-TEXT_PADDING))}if(longText!=""&&nickName!=""){noStroke();textFont(font,FONT_SIZE);textLeading(TEXT_LEADING);if(longTextLines==-1){if(longTextAlign=="left")textAlign(LEFT,CENTER);else textAlign(CENTER,CENTER);fill(UI_BG);rect(0,0,width,height);fill(LABEL_NEUTRAL_COLOR);text(longText,LONG_TEXT_PADDING,LONG_TEXT_PADDING,width-LONG_TEXT_PADDING*2,height-LONG_TEXT_PADDING*2-1)}else{if(longTextAlign=="left")textAlign(LEFT,BASELINE);else textAlign(CENTER,BASELINE);var tw=LONG_TEXT_BOX_W-LONG_TEXT_PADDING*2;var th=longTextLines*TEXT_LEADING;if(longTextAlign=="center"&&longTextLines==1)tw=textWidth(longText+" ");var rw=tw+LONG_TEXT_PADDING*2;var rh=th+LONG_TEXT_PADDING*2;fill(UI_BG);rect(floor(width/2-rw/2),floor(height/2-rh/2),floor(rw),floor(rh));fill(LABEL_NEUTRAL_COLOR);text(longText,floor(width/2-tw/2+LONG_TEXT_PADDING-1),floor(height/2-th/2)+TEXT_LEADING-3,floor(tw))}}if(nickName==""&&(logoCounter<LOGO_STAY||LOGO_STAY==-1)){logoCounter+=deltaTime;animation(logo,floor(width/2),floor(height/2))}}}function windowResized(){scaleCanvas()}function scaleCanvas(){if(windowWidth>windowHeight){canvasScale=windowHeight/WIDTH;canvas.style("width",WIDTH*canvasScale+"px");canvas.style("height",HEIGHT*canvasScale+"px")}else{canvasScale=windowWidth/WIDTH;canvas.style("width",WIDTH*canvasScale+"px");canvas.style("height",HEIGHT*canvasScale+"px")}var container=document.getElementById("canvas-container");container.setAttribute("style","width:"+WIDTH*canvasScale+"px; height: "+HEIGHT*canvasScale+"px");var form=document.getElementById("interface");form.setAttribute("style","width:"+WIDTH*canvasScale+"px;");var projection=document.getElementById("iframe_video");projection.setAttribute("style","width:"+((WIDTH-64)*canvasScale)+"px; height: "+((HEIGHT-90)*canvasScale)+"px")}function avatarSelection(){menuGroup=new Group();screen="avatar";var previousBody,nextBody,previousColor,nextColor;var ss=loadSpriteSheet(arrowButton,28,28,3);var animation=loadAnimation(ss);previousBody=createSprite(8*ASSET_SCALE+14,50*ASSET_SCALE+14);previousBody.addAnimation("default",animation);previousBody.animation.stop();previousBody.mirrorX(-1);menuGroup.add(previousBody);nextBody=createSprite(24*ASSET_SCALE+14,50*ASSET_SCALE+14);nextBody.addAnimation("default",animation);nextBody.animation.stop();menuGroup.add(nextBody);previousColor=createSprite(90*ASSET_SCALE+14,50*ASSET_SCALE+14);previousColor.addAnimation("default",animation);previousColor.animation.stop();previousColor.mirrorX(-1);menuGroup.add(previousColor);nextColor=createSprite(106*ASSET_SCALE+14,50*ASSET_SCALE+14);nextColor.addAnimation("default",animation);nextColor.animation.stop();menuGroup.add(nextColor);previousBody.onMouseOver=nextBody.onMouseOver=previousColor.onMouseOver=nextColor.onMouseOver=function(){this.animation.changeFrame(1)};previousBody.onMouseOut=nextBody.onMouseOut=previousColor.onMouseOut=nextColor.onMouseOut=function(){this.animation.changeFrame(0)};previousBody.onMousePressed=nextBody.onMousePressed=previousColor.onMousePressed=nextColor.onMousePressed=function(){this.animation.changeFrame(2)};previousBody.onMouseReleased=function(){currentAvatar-=1;if(currentAvatar<0)currentAvatar=AVATARS-1;previewAvatar();this.animation.changeFrame(1)};nextBody.onMouseReleased=function(){currentAvatar+=1;if(currentAvatar>=AVATARS)currentAvatar=0;previewAvatar();this.animation.changeFrame(1)};previousColor.onMouseReleased=function(){paletteIndex--;if(paletteIndex>=0)currentColors=generatedPalettes[paletteIndex];else{currentColors=randomizeAvatarColors();generatedPalettes.unshift(currentColors);paletteIndex=0}previewAvatar();this.animation.changeFrame(1)};nextColor.onMouseReleased=function(){paletteIndex++;if(paletteIndex>generatedPalettes.length-1){currentColors=randomizeAvatarColors();generatedPalettes.push(currentColors)}else{currentColors=generatedPalettes[paletteIndex]}previewAvatar();this.animation.changeFrame(1)};randomAvatar()}function Player(p){this.id=p.id;this.nickName=p.nickName;this.colors=p.colors;this.avatar=p.avatar;this.ignore=false;this.tint=color("#FFFFFF");if(ROOMS[p.room].tint!=null){this.tint=color(ROOMS[p.room].tint)}this.avatarGraphics=paletteSwap(walkSheets[p.avatar],p.colors,this.tint);this.spriteSheet=loadSpriteSheet(this.avatarGraphics,AVATAR_W,AVATAR_H,round(walkSheets[p.avatar].width/AVATAR_W));this.walkAnimation=loadAnimation(this.spriteSheet);this.emoteGraphics=paletteSwap(emoteSheets[p.avatar],p.colors,this.tint);this.emoteSheet=loadSpriteSheet(this.emoteGraphics,AVATAR_W,AVATAR_H,round(emoteSheets[p.avatar].width/AVATAR_W));this.emoteAnimation=loadAnimation(this.emoteSheet);this.emoteAnimation.frameDelay=10;this.sprite=createSprite(100,100);this.sprite.scale=ROOMS[p.room].avatarScale;this.sprite.addAnimation("walk",this.walkAnimation);this.sprite.addAnimation("emote",this.emoteAnimation);if(this.nickName=="")this.sprite.mouseActive=false;else this.sprite.mouseActive=true;this.sprite.setCollider("rectangle",0,0,4,10);this.sprite.id=this.id;this.sprite.label=p.nickName;this.sprite.transparent=false;this.sprite.roomId=p.room;this.sprite.avatar=true;this.sprite.depthOffset=AVATAR_H/2;var c1=color(TOP_COLORS[p.colors[2]]);var c2=color(BOTTOM_COLORS[p.colors[3]]);if(brightness(c1)>30)this.sprite.labelColor=TOP_COLORS[p.colors[2]];else if(brightness(c2)>30)this.sprite.labelColor=BOTTOM_COLORS[p.colors[3]];else this.sprite.labelColor=LABEL_NEUTRAL_COLOR;this.labelColor=this.sprite.labelColor;this.room=p.room;this.x=p.x;this.y=p.y;this.dir=1;this.destinationX=p.destinationX;this.destinationY=p.destinationY;if(this.nickName=="")this.sprite.visible=false;this.stopWalkingAnimation=function(){if(this.sprite.getAnimationLabel()=="walk"){this.sprite.changeAnimation("emote");this.sprite.animation.changeFrame(0);this.sprite.animation.stop()}};this.playWalkingAnimation=function(){this.sprite.changeAnimation("walk");this.sprite.animation.play()};this.updatePosition=function(){this.sprite.position.x=round(this.x);this.sprite.position.y=round(this.y-(AVATAR_H/2)*this.sprite.scale)};if(this.nickName!=""){this.sprite.onMouseOver=function(){rolledSprite=this};this.sprite.onMouseOut=function(){if(rolledSprite==this)rolledSprite=null};this.sprite.onMousePressed=function(){}}this.sprite.originalDraw=this.sprite.draw;this.sprite.draw=function(){if(!this.ignore){if(this.transparent)tint(255,100);if(window[this.roomId+"DrawSprite"]!=null){window[this.roomId+"DrawSprite"](this.id,this,this.originalDraw)}else{this.originalDraw()}if(this.transparent)noTint()}};this.stopWalkingAnimation()}function deleteAllSprites(){allSprites.removeSprites()}function Bubble(pid,message,col,x,y,oy){this.row=0;this.pid=pid;this.message=message;this.color=color(col);this.orphan=false;this.counter=BUBBLE_TIME;this.fontScale=1;if(message.length<4){this.fontScale=2;this.message=this.message.toUpperCase()}textFont(font,FONT_SIZE*this.fontScale);textAlign(LEFT,BASELINE);this.tw=textWidth(this.message);this.w=round(this.tw+TEXT_PADDING*2);this.h=round(TEXT_H+TEXT_PADDING*2*this.fontScale);this.px=round(x);this.py=round(y);this.offY=oy;this.x=round(this.px-this.w/2);if(this.x+this.w+BUBBLE_MARGIN>width){this.x=width-this.w-BUBBLE_MARGIN}if(this.x<BUBBLE_MARGIN){this.x=BUBBLE_MARGIN}this.update=function(){this.counter-=deltaTime/1000;noStroke();textFont(font,FONT_SIZE*this.fontScale);textAlign(LEFT,BASELINE);rectMode(CORNER);fill(UI_BG);this.y=this.offY-floor((TEXT_H+TEXT_PADDING*2+BUBBLE_MARGIN)*this.row);rect(this.x,this.y,this.w+1,this.h);fill(this.color);text(this.message,floor(this.x+TEXT_PADDING)+1,floor(this.h+this.y-TEXT_PADDING))}}function pushBubbles(b){for(var i=0;i<bubbles.length;i++){if(bubbles[i]!=b&&bubbles[i].row==b.row){if(b.x<bubbles[i].x+bubbles[i].w&&b.x+b.w>bubbles[i].x){bubbles[i].row++;pushBubbles(bubbles[i]);if(bubbles[i].y-bubbles[i].h<0)bubbles[i].counter=-1}}}}function isObstacle(x,y,room,a){var obs=true;if(room!=null&&a!=null){var px=floor(map(x,0,WIDTH,0,a.width));var py=floor(map(y,0,HEIGHT,0,a.height));var c1=a.get(px,py);if(c1[0]!=255||c1[1]!=255||c1[2]!=255){var cmd=getCommand(c1,room);if(cmd!=null)if(cmd.obstacle!=null)obs=cmd.obstacle}else obs=false}return obs}var touchDown=false;function mouseDragged(){mouseMoved()}function touchMoved(){mouseMoved();touchDown=true}function touchEnded(){if(touchDown){touchDown=false;canvasReleased()}}function mouseMoved(){if(walkIcon!=null)walkIcon.visible=false;if(areas!=null&&me!=null){var mx=floor(map(mouseX,0,WIDTH,0,areas.width));var my=floor(map(mouseY,0,HEIGHT,0,areas.height));var c=areas.get(mx,my);areaLabel="";if(alpha(c)!=0&&me.room!=null){if(c[0]==255&&c[1]==255&&c[2]==255){if(walkIcon!=null)walkIcon.visible=true}else{var command=getCommand(c,me.room);if(command!=null)if(command.label!=null){areaLabel=command.label}}}}}function canvasPressed(){if(nickName!=""&&screen=="game"&&mouseButton==RIGHT){if(me.destinationX==me.x&&me.destinationY==me.y)socket.emit("emote",{room:me.room,em:true})}}function canvasReleased(){if(screen=="error"){}else if(nickName!=""&&screen=="game"&&mouseButton==RIGHT){if(me.destinationX==me.x&&me.destinationY==me.y)socket.emit("emote",{room:me.room,em:false})}else if(nickName!=""&&screen=="game"&&mouseButton==LEFT){if(longText!=""&&longText!=SETTINGS.INTRO_TEXT){if(longTextLink!="")window.open(longTextLink,"_blank");longText="";longTextLink=""}else if(me!=null){longText="";longTextLink="";if(AFK){AFK=false;if(socket!=null)socket.emit("focus",{room:me.room})}if(rolledSprite!=null){if(rolledSprite.id!=null){nextCommand=null;var t=players[rolledSprite.id];if(t!=null&&t!=me){var d=me.x<t.x?-(AVATAR_W*2):AVATAR_W*2;socket.emit("move",{x:me.x,y:me.y,room:me.room,destinationX:t.x+d,destinationY:t.y,})}}}else if(areas!=null&&me.room!=null){var mx=floor(map(mouseX,0,WIDTH,0,areas.width));var my=floor(map(mouseY,0,HEIGHT,0,areas.height));var c=areas.get(mx,my);if(alpha(c)!=255){nextCommand=null;if(me.x!=me.destinationX&&me.y!=me.destinationY)socket.emit("move",{x:me.x,y:me.y,room:me.room,destinationX:me.x,destinationY:me.y,})}else if(c[0]==255&&c[1]==255&&c[2]==255){nextCommand=null;socket.emit("move",{x:me.x,y:me.y,room:me.room,destinationX:mouseX,destinationY:mouseY,})}else{var command=getCommand(c,me.room);if(command!=null)moveToCommand(command)}}}}}function moveToCommand(command){nextCommand=command;if(command.point!=null){me.destinationX=command.point[0]*ASSET_SCALE;me.destinationY=command.point[1]*ASSET_SCALE;socket.emit("move",{x:me.x,y:me.y,room:me.room,destinationX:command.point[0]*ASSET_SCALE,destinationY:command.point[1]*ASSET_SCALE,})}else{me.destinationX=mouseX;me.destinationY=mouseY;socket.emit("move",{x:me.x,y:me.y,room:me.room,destinationX:mouseX,destinationY:mouseY,})}}function getCommand(c,roomId){try{var cString=color(c).toString("#rrggbb");var areaColors=ROOMS[roomId].areaColors;var command;for(var colorId in areaColors){if(areaColors.hasOwnProperty(colorId)){var aString="#"+colorId.substr(1);if(aString==cString){command=areaColors[colorId]}}}}catch(e){console.log("Get command error "+roomId+" color "+c);console.error(e)}return command}function executeCommand(c){areaLabel="";switch(c.cmd){case"enter":var sx,sy;if(ROOMS[c.room]!=null){if(ROOMS[me.room].musicLoop!=null){ROOMS[me.room].musicLoop.stop()}console.log(me.room);if(moment().isBetween(moment(ROOMS[c.room].startDate),moment(ROOMS[c.room].endDate))){if(c.enterPoint!=null){sx=c.enterPoint[0]*ASSET_SCALE;sy=c.enterPoint[1]*ASSET_SCALE;socket.emit("changeRoom",{from:me.room,to:c.room,x:sx,y:sy,})}else if(ROOMS[c.room].spawn!=null){spawnZone=ROOMS[c.room].spawn;sx=round(random(spawnZone[0]*ASSET_SCALE,spawnZone[2]*ASSET_SCALE));sy=round(random(spawnZone[1]*ASSET_SCALE,spawnZone[3]*ASSET_SCALE));socket.emit("changeRoom",{from:me.room,to:c.room,x:sx,y:sy,})}else{console.log("ERROR: No spawn point or area set for "+c.room)}}else{console.log("ERROR: That room is currently closed");executeCommand({cmd:"text",txt:"Esta sala se encuentra cerrada",align:"center",lines:1})}}break;case"action":if(c.actionId!=null){socket.emit("action",c.actionId)}break;case"text":if(c.txt!=null){longText=c.txt;if(c.lines!=null)longTextLines=c.lines;else longTextLines=1;if(c.align!=null)longTextAlign=c.align;else longTextAlign="center";if(c.url==null)longTextLink="";else longTextLink=c.url}else print("Warning for text: make sure to specify arg as text");break}}function keyPressed(){if(screen=="game"){var field=document.getElementById("chatField");field.focus()}if(screen=="user"){var field=document.getElementById("lobby-field");field.focus()}}function talk(msg){if(AFK){AFK=false;if(socket!=null&&me!=null)socket.emit("focus",{room:me.room})}if(msg.replace(/\s/g,"")!=""&&nickName!=""){var command=commandLine(msg);if(!command)socket.emit("talk",{message:msg,color:me.labelColor,room:me.room,x:me.x,y:me.y,})}}function commandLine(msg){var found=false;switch(msg.toLowerCase()){case"/sound off":SOUND=false;found=true;break;case"/sound on":SOUND=true;found=true;break;case"/afk":if(socket!=null&&me!=null)socket.emit("blur",{room:me.room});AFK=true;found=true;break}return found}function getTalkInput(){var time=new Date().getTime();if(time-lastMessage>SETTINGS.ANTI_SPAM){var inputVal=document.getElementById("chatField").value;talk(inputVal);document.getElementById("chatField").value="";lastMessage=time;longText="";longTextLink=""}return false}function nameOk(){var v=document.getElementById("lobby-field").value;if(v!=""){nickName=v;if(socket!=null){socket.emit("sendName",v)}return false}}function nameValidationCallBack(code){if(socket.id){if(code==0){console.log("Username already taken");var e=document.getElementById("lobby-error");if(e!=null)e.innerHTML="Username already taken"}else if(code==3){var e=document.getElementById("lobby-error");if(e!=null)e.innerHTML="Sorry, only standard western characters are allowed"}else{hideUser();showAvatar();avatarSelection()}}}function randomAvatar(){currentAvatar=floor(random(0,AVATARS));previewAvatar()}function previewAvatar(){if(avatarPreview!=null)removeSprite(avatarPreview);var aGraphics=paletteSwap(emoteSheets[currentAvatar],currentColors);var aSS=loadSpriteSheet(aGraphics,AVATAR_W,AVATAR_H,round(emoteSheets[currentAvatar].width/AVATAR_W));var aAnim=loadAnimation(aSS);avatarPreview=createSprite(width/2,height/2);avatarPreview.scale=4;avatarPreview.addAnimation("default",aAnim);avatarPreview.animation.frameDelay=10;menuGroup.add(avatarPreview)}function randomizeAvatarColors(){return[floor(random(0,HAIR_COLORS.length)),floor(random(0,SKIN_COLORS.length)),floor(random(0,TOP_COLORS.length)),floor(random(0,BOTTOM_COLORS.length)),]}function paletteSwap(ss,paletteNumbers,t){var tint=[255,255,255];if(t!=null)tint=[red(t),green(t),blue(t)];var img=createImage(ss.width,ss.height);img.copy(ss,0,0,ss.width,ss.height,0,0,ss.width,ss.height);img.loadPixels();var palette=[];palette[0]=HAIR_COLORS_RGB[paletteNumbers[0]];palette[1]=SKIN_COLORS_RGB[paletteNumbers[1]];palette[2]=TOP_COLORS_RGB[paletteNumbers[2]];palette[3]=BOTTOM_COLORS_RGB[paletteNumbers[3]];for(var i=0;i<img.pixels.length;i+=4){if(img.pixels[i+3]==255){var found=false;for(var j=0;j<REF_COLORS_RGB.length&&!found;j++){if(img.pixels[i]==REF_COLORS_RGB[j][0]&&img.pixels[i+1]==REF_COLORS_RGB[j][1]&&img.pixels[i+2]==REF_COLORS_RGB[j][2]){found=true;img.pixels[i]=(palette[j][0]*tint[0])/255;img.pixels[i+1]=(palette[j][1]*tint[1])/255;img.pixels[i+2]=(palette[j][2]*tint[2])/255}}}}img.updatePixels();return img}function tintGraphics(img,colorString){var c=color(colorString);let pg=createGraphics(img.width,img.height);pg.noSmooth();pg.tint(red(c),green(c),blue(c),255);pg.image(img,0,0,img.width,img.height);var img=createImage(pg.width,pg.height);img.copy(pg,0,0,pg.width,pg.height,0,0,pg.width,pg.height);return img}function createThing(thing,id){var f=1;if(thing.frames!=null)f=thing.frames;var sw=floor(thing.spriteGraphics.width/f);var sh=thing.spriteGraphics.height;var ss=loadSpriteSheet(thing.spriteGraphics,sw,sh,f);var animation=loadAnimation(ss);if(thing.frameDelay!=null)animation.frameDelay=thing.frameDelay;var ox=sw%2;var oy=sh%2;var newSprite=createSprite(floor(thing.position[0]+sw/2)*ASSET_SCALE+ox,floor(thing.position[1]+sh/2)*ASSET_SCALE+oy);newSprite.addAnimation("default",animation);newSprite.depthOffset=floor(sh/2)-4;newSprite.id=id;newSprite.scale=ASSET_SCALE;if(thing.visible!=null){newSprite.visible=thing.visible}newSprite.label=thing.label;if(thing.label!=null){newSprite.onMouseOver=function(){rolledSprite=this};newSprite.onMouseOut=function(){if(rolledSprite==this)rolledSprite=null}}if(thing.command!=null){newSprite.command=thing.command;newSprite.onMouseReleased=function(){if(rolledSprite==this)moveToCommand(this.command)}}return newSprite}function removeThing(thingId,thingRoom){if(me.room==thingRoom){var roomSprites=getSprites();for(var i=0;i<roomSprites.length;i++){if(roomSprites[i].id==thingId){roomSprites[i].remove()}}}}function joinGame(){deleteAllSprites();hideJoin();if(QUICK_LOGIN){nickName="user"+floor(random(0,1000));currentAvatar=floor(random(0,emoteSheets.length));newGame()}else{screen="user";showUser()}}function bodyOk(){newGame()}function keyTyped(){if(screen=="avatar"){if(keyCode===ENTER||keyCode===RETURN){newGame()}}}function showUser(){var e=document.getElementById("user-form");if(e!=null)e.style.display="block";e=document.getElementById("lobby-container");if(e!=null)e.style.display="block"}function hideUser(){var e=document.getElementById("user-form");if(e!=null)e.style.display="none";e=document.getElementById("lobby-container");if(e!=null)e.style.display="none"}function showAvatar(){var e=document.getElementById("avatar-form");if(e!=null){e.style.display="block"}}function showLoading(show){var loadingScreen=document.getElementById("loading-screen");if(loadingScreen!=null){if(!show){loadingScreen.remove()}}}function hideAvatar(){var e=document.getElementById("avatar-form");if(e!=null)e.style.display="none"}function showJoin(){document.getElementById("join-form").style.display="block"}function hideJoin(){document.getElementById("join-form").style.display="none"}function showChat(){var e=document.getElementById("talk-form");if(e!=null)e.style.display="block"}function hideChat(){var e=document.getElementById("talk-form");if(e!=null)e.style.display="none"}function outOfCanvas(){areaLabel="";rolledSprite=null}function preventBehavior(e){e.preventDefault()}document.addEventListener("touchmove",preventBehavior,{passive:false});window.addEventListener("focus",function(){if(socket!=null&&me!=null)socket.emit("focus",{room:me.room})});window.addEventListener("blur",function(){if(socket!=null&&me!=null)socket.emit("blur",{room:me.room})});